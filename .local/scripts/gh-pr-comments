#!/usr/bin/env bash

OUTPUT_JSON=false
if [[ "$1" == "--json" ]]; then
  OUTPUT_JSON=true
fi

read owner repo number < <(gh pr view --json headRepositoryOwner,headRepository,number -q '[.headRepositoryOwner.login, .headRepository.name, .number] | @tsv')

response=$(gh api graphql -f query='
  query($owner: String!, $repo: String!, $number: Int!) {
    repository(owner: $owner, name: $repo) {
      pullRequest(number: $number) {
        state
        merged
        mergeable
        mergeStateStatus
        baseRefName
        headRefName
        comments(first: 100) {
          nodes {
            id
            databaseId
            body
            author { login }
            createdAt
          }
        }
        latestReviews(first: 100) {
          nodes {
            author { login }
            state
            submittedAt
          }
        }
        reviewThreads(first: 100) {
          nodes {
            id
            isResolved
            resolvedBy { login }
            comments(first: 100) {
              nodes {
                id
                databaseId
                body
                author { login }
                createdAt
                path
                line
                diffHunk
                replyTo { id }
              }
            }
          }
        }
      }
    }
  }
' -f owner="$owner" -f repo="$repo" -F number="$number")

if $OUTPUT_JSON; then
  echo "$response" | jq '.data.repository.pullRequest | {
    state,
    merged,
    mergeable,
    mergeStateStatus,
    baseRefName,
    headRefName,
    reviews: .latestReviews.nodes,
    comments: [.comments.nodes[] | select(.author.login != "claude")],
    reviewThreads: .reviewThreads.nodes
  }'
  exit 0
fi

echo "$response" | jq -r '
"PR Status: \(if .data.repository.pullRequest.merged then "MERGED" elif .data.repository.pullRequest.state == "OPEN" then "OPEN" else "CLOSED" end)",
"Branch: \(.data.repository.pullRequest.headRefName) â†’ \(.data.repository.pullRequest.baseRefName)",
"Merge State: \(.data.repository.pullRequest.mergeStateStatus // "UNKNOWN")",
"Mergeable: \(
  if .data.repository.pullRequest.mergeable == "MERGEABLE" then "âœ“ No conflicts"
  elif .data.repository.pullRequest.mergeable == "CONFLICTING" then "âœ— HAS CONFLICTS"
  elif .data.repository.pullRequest.mergeable == "UNKNOWN" then "? Checking..."
  else .data.repository.pullRequest.mergeable // "UNKNOWN"
  end
)",
"",
"REVIEWS:",
(.data.repository.pullRequest.latestReviews.nodes | if length > 0 then
  map("  @\(.author.login): \(if .state == "APPROVED" then "âœ“ APPROVED" elif .state == "CHANGES_REQUESTED" then "âœ— CHANGES REQUESTED" elif .state == "COMMENTED" then "ðŸ’¬ COMMENTED" elif .state == "DISMISSED" then "âŠ˜ DISMISSED" else .state end) (\(.submittedAt))") | join("\n")
else "  No reviews yet" end),
"",
"================================",
"",
(if (.data.repository.pullRequest.comments.nodes | map(select(.author.login != "claude")) | length) > 0 then
"CONVERSATION COMMENTS:",
"",
(.data.repository.pullRequest.comments.nodes[] | select(.author.login != "claude") |
"@\(.author.login) - \(.createdAt) [Comment ID: \(.databaseId)]",
"  " + (.body | gsub("\n"; "\n  ")),
""
),
"================================",
""
else "" end),
(.data.repository.pullRequest.reviewThreads.nodes | map(select(.isResolved)) | length) as $resolved |
(.data.repository.pullRequest.reviewThreads.nodes | map(select(.isResolved | not))) as $open |
(if $resolved > 0 then "\($resolved) resolved comment\(if $resolved > 1 then "s" else "" end)" else "" end),
"",
(if ($open | length) > 0 then
"OPEN REVIEW THREADS:",
"",
($open[] |
"--------------------------------",
"Thread ID: \(.id)",
(if .comments.nodes[0].path then "File: \(.comments.nodes[0].path)" + (if .comments.nodes[0].line then ":\(.comments.nodes[0].line)" else "" end) else "" end),
"",
(.comments.nodes[] |
  (if .replyTo then "> " else "" end) +
  "@\(.author.login) - \(.createdAt) [Reply ID: \(.databaseId)]",
  "  " + (.body | gsub("\n"; "\n  ")),
  (if .diffHunk and .diffHunk != "" and (.replyTo | not) then "\n  Code context:\n" + ("  " + (.diffHunk | gsub("\n"; "\n  "))) else "" end),
  ""
),
""
)
else "" end)
'

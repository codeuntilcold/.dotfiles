#!/usr/bin/env bash

get_bt_battery() {
    local device=$1
    local icon=$2
    local battery=$(bluetoothctl info "$device" 2>/dev/null | grep -oP 'Battery Percentage: 0x[0-9a-f]+ \(\K\d+')
    if [[ -n "$battery" ]]; then
        echo "${icon} ${battery}%"
    else
        echo ""
    fi
}

get_gpu_load() {
    local gpu_load=$(nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits 2>/dev/null)
    if [[ -n "$gpu_load" ]]; then
        echo "GPU ${gpu_load}%"
    else
        echo ""
    fi
}

get_weather() {
    local cache_file="/tmp/wttr_cache"
    local cache_time=600  # 10 minutes

    if [[ -f "$cache_file" ]] && [[ $(($(date +%s) - $(stat -c %Y "$cache_file"))) -lt $cache_time ]]; then
        cat "$cache_file"
    else
        local weather=$(curl -s --max-time 2 'wttr.in/?format=%c+%t+%p' 2>/dev/null)
        if [[ -n "$weather" ]]; then
            echo "$weather" > "$cache_file"
            echo "$weather"
        elif [[ -f "$cache_file" ]]; then
            cat "$cache_file"
        fi
    fi
}

i3status "$@" | while :
do
    read -r line
    xm6_bat=$(get_bt_battery "58:18:62:01:E5:78" "XM6")
    corne_bat=$(get_bt_battery "D3:AC:8D:04:52:D5" "CRN")
    gpu_load=$(get_gpu_load)
    weather=$(get_weather)

    status_items=""
    [[ -n "$xm6_bat" ]] && status_items+=" ${xm6_bat} |"
    [[ -n "$corne_bat" ]] && status_items+=" ${corne_bat} |"

    echo "${line} | ðŸ”† $(xbrightness) | ${gpu_load} | ${weather} |${status_items}" || exit 1
done
